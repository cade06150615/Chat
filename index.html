<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>好友聊天室</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f4f8; }
    .chat-container { height: calc(100vh - 240px); min-height: 400px; }
    .message { max-width: 80%; word-break: break-word; }
    .message-container { overflow-y: auto; height: calc(100% - 60px); }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body>
<div class="min-h-screen flex flex-col">
  <nav class="bg-indigo-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">好友聊天室</h1>
      <div class="flex items-center space-x-4">
        <span id="username-display" class="hidden md:inline-block">未登入</span>
        <button id="logout-btn" class="bg-indigo-700 px-4 py-1 rounded-full text-sm font-medium hover:bg-indigo-800 transition hidden">登出</button>
      </div>
    </div>
  </nav>

  <div class="container mx-auto flex-grow p-4">
    <div id="auth-container" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6 mt-10">
      <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">歡迎來到好友聊天室</h2>
      <div class="space-y-4">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-1">使用者名稱</label>
          <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300 rounded-md">
        </div>
        <div>
          <label for="invite-code-input" class="block text-sm font-medium text-gray-700 mb-1">邀請碼 (選填)</label>
          <input type="text" id="invite-code-input" class="w-full px-4 py-2 border border-gray-300 rounded-md" placeholder="有邀請碼嗎？請輸入">
        </div>
        <button id="login-btn" class="w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition font-medium">進入聊天室</button>
      </div>
    </div>

    <div id="chat-container" class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-4 mt-4 hidden chat-container">
      <div id="message-container" class="message-container p-4 space-y-3">
        <div class="text-center text-gray-500 text-sm py-2">— 開始聊天 —</div>
      </div>
      <div class="border-t mt-2 pt-3 flex">
        <input type="text" id="message-input" class="flex-grow px-4 py-2 border border-gray-300 rounded-l-md" placeholder="輸入訊息...">
        <button id="send-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-r-md hover:bg-indigo-700 transition">發送</button>
      </div>
    </div>
  </div>
</div>

<script>
const socket = io("https://chat-backed-h4en.onrender.com"); // 替換為你的 render 網址

const authContainer = document.getElementById("auth-container");
const chatContainer = document.getElementById("chat-container");
const usernameInput = document.getElementById("username");
const inviteCodeInput = document.getElementById("invite-code-input");
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const messageContainer = document.getElementById("message-container");
const usernameDisplay = document.getElementById("username-display");

let currentUser = null;

loginBtn.addEventListener("click", () => {
  const username = usernameInput.value.trim();
  const inviteCode = inviteCodeInput.value.trim();
  if (!username) return alert("請輸入使用者名稱");
  currentUser = { name: username };
  socket.emit("login", { username, inviteCode });
  authContainer.classList.add("hidden");
  chatContainer.classList.remove("hidden");
  usernameDisplay.textContent = username;
  usernameDisplay.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
});

logoutBtn.addEventListener("click", () => {
  location.reload();
});

sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter") sendMessage();
});

function sendMessage() {
  const message = messageInput.value.trim();
  if (!message) return;
  socket.emit("chat-message", message);
  messageInput.value = "";
  messageInput.focus();
}

function displayMessage(message) {
  const isCurrentUser = message.user === currentUser.name;
  const messageDiv = document.createElement("div");
  messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} fade-in`;

  const time = new Date(message.time);
  const formattedTime = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;

  messageDiv.innerHTML = `
    <div class="message ${isCurrentUser ? 'bg-indigo-100 text-indigo-900' : 'bg-gray-100 text-gray-900'} rounded-lg px-4 py-2 relative">
      ${!isCurrentUser ? `<div class="font-medium text-sm text-indigo-600">${message.user}</div>` : ''}
      <p>${message.text}</p>
      <div class="text-xs text-gray-500 text-right mt-1">${formattedTime}</div>
    </div>
  `;
  messageContainer.appendChild(messageDiv);
  messageContainer.scrollTop = messageContainer.scrollHeight;
}

socket.on("chat-history", (messages) => {
  messageContainer.innerHTML = '<div class="text-center text-gray-500 text-sm py-2">— 歷史訊息 —</div>';
  messages.forEach(displayMessage);
});

socket.on("chat-message", displayMessage);
socket.on("system-message", (text) => {
  const systemDiv = document.createElement('div');
  systemDiv.className = 'text-center text-gray-500 text-sm py-2 fade-in';
  systemDiv.textContent = text;
  messageContainer.appendChild(systemDiv);
  messageContainer.scrollTop = messageContainer.scrollHeight;
});

socket.on("invite-code", (code) => {
  alert("你的邀請碼是：" + code);
});
</script>
</body>
</html>
